<mat-card class="header-card no-print">
  <mat-card-header>
    <mat-card-title>Historial</mat-card-title>
    <mat-card-subtitle>{{ rangeLabel }} (pagina {{ pageIndex() + 1 }})</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content class="header-actions">
    <button mat-flat-button color="primary" type="button" (click)="printHistorial()" [disabled]="loading()">
      <mat-icon aria-hidden="true">print</mat-icon>
      Imprimir
    </button>
    <button mat-flat-button color="accent" type="button" (click)="exportExcel()" [disabled]="loading()">
      <mat-icon aria-hidden="true">file_download</mat-icon>
      Exportar Excel
    </button>
  </mat-card-content>
</mat-card>

<mat-card class="filters-card no-print">
  <mat-card-content>
    <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filters-form">
      <mat-form-field appearance="outline">
        <mat-label>Correlativo</mat-label>
        <input matInput formControlName="correlativo" placeholder="DTI|DSST|AVAL|0001" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Solicitante</mat-label>
        <input matInput formControlName="solicitante" placeholder="Nombre del solicitante" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha registro</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="fecha" placeholder="dd/mm/aaaa" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker startView="multi-year"></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Estado</mat-label>
        <mat-select formControlName="estado">
          <mat-option value="">Todos</mat-option>
          <mat-option value="ACTIVO">ACTIVO</mat-option>
          <mat-option value="ANULADO">ANULADO</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-flat-button color="primary" type="submit" [disabled]="loading()">Filtrar</button>
        <button mat-stroked-button type="button" (click)="clearFilters()" [disabled]="loading()">Limpiar</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<mat-card class="table-card">
  <mat-card-content>
    <div class="table-toolbar no-print">
      <div class="table-toolbar-spacer"></div>
      <mat-paginator
        [length]="total()"
        [pageSize]="pageSize()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="[10, 25, 50]"
        (page)="onPage($event)"
      ></mat-paginator>
    </div>

    <div class="table-wrap" *ngIf="!loading(); else loadingTpl">
      <table mat-table [dataSource]="avales()" class="mat-elevation-z0">
        <ng-container matColumnDef="correlativo">
          <th mat-header-cell *matHeaderCellDef>Correlativo</th>
          <td mat-cell *matCellDef="let aval" class="mono">{{ aval.correlativo }}</td>
        </ng-container>

        <ng-container matColumnDef="fecha_registro">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let aval">{{ formatDmy(aval.fecha_registro) }}</td>
        </ng-container>

        <ng-container matColumnDef="fecha_solicitud">
          <th mat-header-cell *matHeaderCellDef>Fecha Solicitud</th>
          <td mat-cell *matCellDef="let aval">{{ formatDmy(aval.fecha_solicitud) }}</td>
        </ng-container>

        <ng-container matColumnDef="responsable">
          <th mat-header-cell *matHeaderCellDef>Responsable</th>
          <td mat-cell *matCellDef="let aval">{{ aval.responsable ?? '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let aval">
            <span class="status" [class.status-off]="aval.estado === 'ANULADO'">
              {{ aval.estado }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="nombre_solicitante">
          <th mat-header-cell *matHeaderCellDef>Solicitante</th>
          <td mat-cell *matCellDef="let aval">{{ aval.nombre_solicitante }}</td>
        </ng-container>

        <ng-container matColumnDef="cargo">
          <th mat-header-cell *matHeaderCellDef>Cargo</th>
          <td mat-cell *matCellDef="let aval">{{ aval.cargo }}</td>
        </ng-container>

        <ng-container matColumnDef="memorando_solicitud">
          <th mat-header-cell *matHeaderCellDef>Memorando</th>
          <td mat-cell *matCellDef="let aval">
            <div class="memo">{{ aval.memorando_solicitud }}</div>
            <small *ngIf="aval.estado === 'ANULADO'">Motivo: {{ aval.motivo_anulacion }}</small>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let aval" class="row-actions">
            <button mat-stroked-button color="primary" type="button" [disabled]="saving() || aval.estado === 'ANULADO'" (click)="startEdit(aval)">Editar</button>
            <button mat-stroked-button color="warn" type="button" [disabled]="saving() || aval.estado === 'ANULADO'" (click)="anularAval(aval)">Anular</button>
          </td>
        </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackById"></tr>
      </table>

      <p class="empty" *ngIf="avales().length === 0">Aun no hay avales registrados.</p>
    </div>

    <ng-template #loadingTpl>
      <p class="loading">Cargando avales...</p>
    </ng-template>
  </mat-card-content>
</mat-card>
